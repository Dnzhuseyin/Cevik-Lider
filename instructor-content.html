<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIDEO Y√ñNETƒ∞Mƒ∞ - √áevik Lider</title>
    <!-- Authentication Guard -->
    <script src="js/auth-guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; padding: 0; background: #f3f4f6; }
        * { box-sizing: border-box; }
    </style>
</head>
<body>
    <div style="min-height: 100vh; display: flex;">
        <!-- Sidebar -->
        <aside style="width: 256px; background: #0f172a; color: white; padding: 20px; position: fixed; height: 100vh; overflow-y: auto;">
            <h1 style="font-size: 20px; font-weight: bold; margin-bottom: 30px; color: #dc2626;">
                <i class="fas fa-graduation-cap"></i> √áevik Lider Admin
            </h1>
            <nav>
                <a href="instructor-dashboard.html" style="display: block; padding: 12px; margin-bottom: 5px; border-radius: 8px; color: white; text-decoration: none;">
                    <i class="fas fa-tachometer-alt"></i> Genel Bakƒ±≈ü
                </a>
                <a href="instructor-courses.html" style="display: block; padding: 12px; margin-bottom: 5px; border-radius: 8px; color: white; text-decoration: none;">
                    <i class="fas fa-graduation-cap"></i> Eƒüitim Mod√ºlleri
                </a>
                <a href="#" style="display: block; padding: 12px; margin-bottom: 5px; border-radius: 8px; background: #1e293b; color: white; text-decoration: none;">
                    <i class="fas fa-video"></i> Video Y√∂netimi
                </a>
                <a href="instructor-students.html" style="display: block; padding: 12px; margin-bottom: 5px; border-radius: 8px; color: white; text-decoration: none;">
                    <i class="fas fa-users"></i> √ñƒürenci Y√∂netimi
                </a>
            </nav>

            <!-- Logout Button -->
            <div style="position: absolute; bottom: 0; left: 0; width: 100%; padding: 16px; border-top: 1px solid #1e293b;">
                <button onclick="logout()" style="display: flex; align-items: center; color: #9ca3af; background: transparent; border: none; cursor: pointer; width: 100%; text-align: left; transition: color 0.3s;">
                    <i class="fas fa-sign-out-alt" style="margin-right: 12px;"></i>
                    <span>√áƒ±kƒ±≈ü Yap</span>
                </button>
            </div>
    </aside>

        <!-- Main -->
        <main style="margin-left: 256px; padding: 40px; flex: 1;">
            <h1 style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">Video Y√∂netimi</h1>
            <p style="color: #6b7280; margin-bottom: 40px;">Eƒüitim videolarƒ±nƒ± y√∂netin</p>

            <!-- Stats -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px;">
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">Toplam Video</div>
                    <div style="font-size: 32px; font-weight: bold;" id="total-videos">0</div>
                        </div>
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">Toplam Soru</div>
                    <div style="font-size: 32px; font-weight: bold;" id="total-questions">0</div>
                    </div>
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">Aktif Mod√ºl</div>
                    <div style="font-size: 32px; font-weight: bold;" id="active-modules">0</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">Son G√ºncelleme</div>
                    <div style="font-size: 14px; font-weight: bold;" id="last-update">-</div>
                        </div>
                </div>
                
            <!-- Form -->
            <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 20px;">
                    <i class="fas fa-plus-circle" style="color: #1e40af;"></i> Yeni Video Ekle
                </h2>
                <form id="videoForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Video Ba≈ülƒ±ƒüƒ±</label>
                            <input type="text" id="videoTitle" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px;">YouTube URL</label>
                            <input type="url" id="youtubeUrl" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Mod√ºl</label>
                            <select id="videoModule" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                                <option value="">Mod√ºl se√ßin...</option>
                            </select>
                    </div>
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px;">S√ºre (dakika)</label>
                            <input type="number" id="videoDuration" required min="1" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Zorluk</label>
                            <select id="difficulty" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                            <option value="beginner">Ba≈ülangƒ±√ß</option>
                                <option value="intermediate" selected>Orta</option>
                            <option value="advanced">ƒ∞leri</option>
                        </select>
                    </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px;">A√ßƒ±klama</label>
                        <textarea id="videoDescription" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;"></textarea>
                    </div>

                    <!-- PDF D√∂k√ºmanlarƒ± -->
                    <div style="margin-bottom: 20px; padding: 20px; background: #fef2f2; border-radius: 8px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">
                            <i class="fas fa-file-pdf" style="color: #dc2626;"></i> PDF D√∂k√ºmanlarƒ±
                        </h3>
                        <p style="font-size: 12px; color: #6b7280; margin-bottom: 15px;">
                            <i class="fas fa-info-circle"></i> PDF'inizi Google Drive veya Dropbox'a y√ºkleyip link'ini buraya yapƒ±≈ütƒ±rƒ±n
                        </p>
                        <div id="pdf-inputs"></div>
                        <button type="button" onclick="addPDFInput()" style="background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            <i class="fas fa-plus"></i> PDF Ekle
                        </button>
                    </div>

                    <!-- Sorular B√∂l√ºm√º -->
                    <div style="margin-bottom: 20px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="font-size: 16px; font-weight: 600;">
                                <i class="fas fa-question-circle" style="color: #059669;"></i> Sorular
                    </h3>
                            <button type="button" onclick="addQuestion()" style="background: #059669; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-plus"></i> Soru Ekle
                        </button>
                    </div>
                        <div id="questions-container"></div>
            </div>

                    <button type="submit" style="background: #6366f1; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-save"></i> Videoyu Kaydet
                    </button>
                </form>
            </div>

            <!-- Videos -->
            <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 20px; font-weight: bold;">
                        <i class="fas fa-video" style="color: #1e40af;"></i> Y√ºklenen Videolar
                    </h2>
                    <select id="filterModule" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                            <option value="">T√ºm Mod√ºller</option>
                        </select>
                    </div>
                <div id="videos-container" style="min-height: 200px;">
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #3b82f6; margin-bottom: 20px;"></i>
                        <p style="color: #6b7280;">Videolar y√ºkleniyor...</p>
                </div>
            </div>
        </div>
    </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="js/firebase-production.js"></script>
    <script>
        console.log('üöÄ VIDEO Y√ñNETƒ∞Mƒ∞ SAYFASI BA≈ûLATILIYOR...');

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('‚úÖ DOM hazƒ±r');
            
            // Wait for Firebase
            let attempts = 0;
            while ((!window.DB || !window.DB.isFirebaseReady) && attempts < 100) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
                if (attempts % 10 === 0) console.log('‚è≥ Firebase bekleniyor...');
            }
            
            if (!window.DB || !window.DB.isFirebaseReady) {
                alert('Firebase baƒülanamadƒ±!');
                return;
            }
            
            console.log('‚úÖ Firebase hazƒ±r');
            
            await loadModules();
            await loadVideos();
            
            document.getElementById('videoForm').addEventListener('submit', handleSubmit);
            document.getElementById('filterModule').addEventListener('change', loadVideos);
            
            console.log('‚úÖ SAYFA TAMAMEN HAZIR!');
        });
        
        async function loadModules() {
            try {
                const result = await window.DB.load('modules');
                const modules = (result && result.success) ? result.data : [];

                // Get moduleId from URL if present
                const urlParams = new URLSearchParams(window.location.search);
                const preselectedModuleId = urlParams.get('moduleId');

                ['videoModule', 'filterModule'].forEach(id => {
                    const select = document.getElementById(id);
                    select.innerHTML = id === 'filterModule' ? '<option value="">T√ºm Mod√ºller</option>' : '<option value="">Mod√ºl se√ßin...</option>';
                    modules.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.textContent = m.title || 'ƒ∞simsiz';
                        select.appendChild(opt);
                    });

                    // Pre-select module if moduleId in URL
                    if (preselectedModuleId && id === 'videoModule') {
                        select.value = preselectedModuleId;
                        console.log('‚úÖ Mod√ºl otomatik se√ßildi:', preselectedModuleId);
                    }
                });

                document.getElementById('active-modules').textContent = modules.length;
                console.log('‚úÖ Mod√ºller:', modules.length);
            } catch (e) {
                console.error('‚ùå Mod√ºl hatasƒ±:', e);
            }
        }
        
        async function loadVideos() {
            try {
                console.log('üìπ Videolar y√ºkleniyor...');

                // AGGRESSIVE CACHE CLEARING
                if (window.DB) {
                    // Clear specific cache
                    if (window.DB.clearCache) {
                        window.DB.clearCache('coordinatorVideos');
                    }
                    // Clear all cache
                    if (window.DB.cache) {
                        window.DB.cache.clear();
                    }
                    console.log('üîÑ T√ºm cache temizlendi');
                }

                // Force fresh load directly from Firestore
                let videos = [];
                if (window.DB && window.DB.db) {
                    console.log('üî• Firestore\'dan direkt y√ºkleniyor...');
                    const snapshot = await window.DB.db.collection('coordinator_videos').get();
                    videos = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    console.log('üìä Firestore\'dan y√ºklenen video:', videos.length);
                } else {
                    // Fallback to DB.load
                    const result = await window.DB.load('coordinatorVideos');
                    videos = (result && result.success) ? result.data : [];
                    console.log('üìä DB.load ile y√ºklenen video:', videos.length);
                }

                // Filter out deleted videos
                videos = videos.filter(v => {
                    const isActive = v.status !== 'deleted';
                    if (!isActive) {
                        console.log('üóëÔ∏è Silinen video filtrelendi:', v.title, v.id);
                    }
                    return isActive;
                });

                console.log('üìä Aktif video sayƒ±sƒ±:', videos.length);
                
                const filter = document.getElementById('filterModule').value;
                if (filter) videos = videos.filter(v => v.moduleId === filter);
                
                const container = document.getElementById('videos-container');
                
                if (videos.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:60px;color:#6b7280;">Hen√ºz video yok</div>';
                } else {
                    container.innerHTML = videos.map(v => `
                        <div style="border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:12px;">
                            <div style="display:flex;justify-content:space-between;align-items:start;">
                                <div style="flex:1;">
                                    <h4 style="font-weight:600;margin-bottom:8px;">${v.title}</h4>
                                    <p style="font-size:14px;color:#6b7280;margin-bottom:8px;">${v.description || 'A√ßƒ±klama yok'}</p>
                                    <div style="font-size:12px;color:#9ca3af;">
                                        <span style="margin-right:16px;"><i class="fas fa-clock"></i> ${v.duration || '?'} dk</span>
                                        <span style="margin-right:16px;"><i class="fas fa-signal"></i> ${v.difficulty || 'orta'}</span>
                                        <span><i class="fas fa-question-circle"></i> ${v.questions ? v.questions.length : 0} soru</span>
                </div>
                    </div>
                                <div style="display:flex;gap:8px;">
                                    ${v.youtubeUrl ? `<a href="${v.youtubeUrl}" target="_blank" style="background:#dc2626;color:white;padding:6px 12px;border-radius:4px;text-decoration:none;font-size:12px;"><i class="fab fa-youtube"></i> YouTube</a>` : ''}
                                    <button onclick="editVideo('${v.id}')" style="background:#6366f1;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:12px;"><i class="fas fa-edit"></i> D√ºzenle</button>
                                    <button onclick="deleteVideo('${v.id}')" style="background:#dc2626;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:12px;"><i class="fas fa-trash"></i> Sil</button>
                        </div>
                        </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('total-videos').textContent = videos.length;
                document.getElementById('total-questions').textContent = videos.reduce((sum, v) => sum + (v.questions ? v.questions.length : 0), 0);
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString('tr-TR');
                
                console.log('‚úÖ Videolar y√ºklendi:', videos.length);
            } catch (e) {
                console.error('‚ùå Video hatasƒ±:', e);
                document.getElementById('videos-container').innerHTML = `<div style="text-align:center;padding:60px;color:#dc2626;">Hata: ${e.message}</div>`;
            }
        }

        let questionCount = 0;
        let pdfsData = [];
        let pdfCounter = 0;

        // PDF Functions
        async function addPDF() {
            console.log('üîµ addPDF() fonksiyonu √ßaƒürƒ±ldƒ±');

            const title = document.getElementById('pdf-title').value.trim();
            const fileInput = document.getElementById('pdf-file');
            const file = fileInput.files[0];

            console.log('üìù PDF Ba≈ülƒ±ƒüƒ±:', title);
            console.log('üìÅ Se√ßilen dosya:', file);

            if (!title) {
                console.log('‚ùå PDF ba≈ülƒ±ƒüƒ± bo≈ü');
                alert('PDF ba≈ülƒ±ƒüƒ± gereklidir');
                return;
            }

            if (!file) {
                alert('L√ºtfen bir PDF dosyasƒ± se√ßin');
                return;
            }

            if (!file.type.includes('pdf')) {
                alert('Sadece PDF dosyalarƒ± y√ºklenebilir');
                return;
            }

            const maxSize = 10 * 1024 * 1024; //10MB
            if (file.size > maxSize) {
                alert('PDF boyutu 10MB\'dan k√º√ß√ºk olmalƒ±dƒ±r');
                return;
            }

            const addButton = document.getElementById('add-pdf-btn');
            const progressDiv = document.getElementById('pdf-upload-progress');
            const progressBar = document.getElementById('upload-progress-bar');
            const progressText = document.getElementById('upload-progress-text');

            addButton.disabled = true;
            progressDiv.style.display = 'block';

            try {
                console.log('üì§ PDF y√ºkleniyor:', file.name);

                const result = await window.DB.uploadPDF(file, 'temp');

                if (result.success) {
                    const pdfId = `pdf_${Date.now()}_${pdfCounter++}`;
                    pdfsData.push({
                        id: pdfId,
                        title: title,
                        url: result.url,
                        fileName: result.fileName,
                        size: result.size,
                        storagePath: result.storagePath
                    });

                    renderPDFList();
                    document.getElementById('pdf-title').value = '';
                    fileInput.value = '';

                    alert(`‚úÖ ${file.name} ba≈üarƒ±yla y√ºklendi!`);
                } else {
                    throw new Error('PDF y√ºklenemedi');
                }
            } catch (error) {
                console.error('‚ùå PDF y√ºkleme hatasƒ±:', error);
                alert('PDF y√ºklenirken hata olu≈ütu: ' + error.message);
            } finally {
                addButton.disabled = false;
                progressDiv.style.display = 'none';
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
            }
        }

        function renderPDFList() {
            const container = document.getElementById('pdf-list');

            if (pdfsData.length === 0) {
                container.innerHTML = '<p style="font-size:12px;color:#6b7280;">Hen√ºz PDF eklenmedi</p>';
                return;
            }

            container.innerHTML = pdfsData.map(pdf => `
                <div style="display:flex;align-items:center;justify-content:space-between;background:white;padding:10px;border-radius:4px;margin-bottom:5px;border:1px solid #e5e7eb;">
                    <div style="display:flex;align-items:center;flex:1;">
                        <i class="fas fa-file-pdf" style="color:#dc2626;font-size:18px;margin-right:8px;"></i>
                        <div style="flex:1;">
                            <span style="font-size:13px;font-weight:500;">${pdf.title}</span>
                            ${pdf.size ? `<span style="font-size:11px;color:#6b7280;margin-left:8px;">${formatFileSize(pdf.size)}</span>` : ''}
                        </div>
                    </div>
                    <button type="button" onclick="removePDF('${pdf.id}')" style="background:#dc2626;color:white;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function removePDF(pdfId) {
            const pdf = pdfsData.find(p => p.id === pdfId);
            if (!pdf) return;

            if (pdf.storagePath && confirm('Bu PDF\'i silmek istediƒüinizden emin misiniz?')) {
                try {
                    await window.DB.deletePDF(pdf.storagePath);
                } catch (error) {
                    console.warn('‚ö†Ô∏è PDF Storage\'dan silinemedi:', error);
                }
            }

            pdfsData = pdfsData.filter(p => p.id !== pdfId);
            renderPDFList();
        }

        function addQuestion() {
            questionCount++;
            const container = document.getElementById('questions-container');
            const div = document.createElement('div');
            div.id = 'question-' + questionCount;
            div.style.cssText = 'background:white;padding:15px;border-radius:6px;margin-bottom:10px;border:1px solid #e5e7eb;';
            div.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <strong style="font-size:14px;">Soru ${questionCount}</strong>
                    <button type="button" onclick="removeQuestion(${questionCount})" style="background:#dc2626;color:white;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:12px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="display:block;font-size:13px;margin-bottom:5px;">Soru Metni</label>
                    <input type="text" class="question-text" required style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;">
                    </div>
                <div style="margin-bottom:10px;">
                    <label style="display:block;font-size:13px;margin-bottom:5px;">Soru Tipi</label>
                    <select class="question-type" onchange="updateQuestionType(${questionCount})" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;">
                        <option value="multiple-choice">√áoktan Se√ßmeli</option>
                        <option value="open-ended">A√ßƒ±k U√ßlu</option>
                        <option value="fill-blank">Bo≈üluk Doldurma</option>
                    </select>
                        </div>
                <div class="options-container">
                    <label style="display:block;font-size:13px;margin-bottom:5px;">≈ûƒ±klar (A,B,C,D)</label>
                    <input type="text" class="option-a" placeholder="A ≈üƒ±kkƒ±" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;margin-bottom:5px;font-size:13px;">
                    <input type="text" class="option-b" placeholder="B ≈üƒ±kkƒ±" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;margin-bottom:5px;font-size:13px;">
                    <input type="text" class="option-c" placeholder="C ≈üƒ±kkƒ±" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;margin-bottom:5px;font-size:13px;">
                    <input type="text" class="option-d" placeholder="D ≈üƒ±kkƒ±" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;margin-bottom:5px;font-size:13px;">
                    <label style="display:block;font-size:13px;margin:8px 0 5px;">Doƒüru Cevap</label>
                    <select class="correct-answer" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;">
                            <option value="0">A</option>
                            <option value="1">B</option>
                            <option value="2">C</option>
                            <option value="3">D</option>
                        </select>
                    </div>
                <div style="margin-top:10px;">
                    <label style="display:block;font-size:13px;margin-bottom:5px;">A√ßƒ±klama</label>
                    <textarea class="question-explanation" rows="2" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;"></textarea>
                </div>
            `;
            container.appendChild(div);
        }
        
        function removeQuestion(id) {
            const elem = document.getElementById('question-' + id);
            if (elem) elem.remove();
        }
        
        function updateQuestionType(id) {
            const container = document.getElementById('question-' + id);
            const type = container.querySelector('.question-type').value;
            const optionsDiv = container.querySelector('.options-container');
            
            if (type === 'multiple-choice') {
                optionsDiv.innerHTML = `
                    <label style="display:block;font-size:13px;margin-bottom:5px;">≈ûƒ±klar (A,B,C,D)</label>
                    <input type="text" class="option-a" placeholder="A ≈üƒ±kkƒ±" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;margin-bottom:5px;font-size:13px;">
                    <input type="text" class="option-b" placeholder="B ≈üƒ±kkƒ±" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;margin-bottom:5px;font-size:13px;">
                    <input type="text" class="option-c" placeholder="C ≈üƒ±kkƒ±" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;margin-bottom:5px;font-size:13px;">
                    <input type="text" class="option-d" placeholder="D ≈üƒ±kkƒ±" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;margin-bottom:5px;font-size:13px;">
                    <label style="display:block;font-size:13px;margin:8px 0 5px;">Doƒüru Cevap</label>
                    <select class="correct-answer" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;">
                        <option value="0">A</option>
                        <option value="1">B</option>
                        <option value="2">C</option>
                        <option value="3">D</option>
                    </select>
                `;
            } else if (type === 'fill-blank') {
                optionsDiv.innerHTML = `
                    <label style="display:block;font-size:13px;margin-bottom:5px;">Doƒüru Cevaplar (virg√ºlle ayƒ±rƒ±n)</label>
                    <input type="text" class="correct-answers" placeholder="cevap1, cevap2, cevap3" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;">
                    <p style="font-size:11px;color:#6b7280;margin-top:5px;">Soru metninde [___] kullanarak bo≈üluklarƒ± belirtin</p>
                `;
                    } else {
                optionsDiv.innerHTML = '<p style="font-size:12px;color:#6b7280;">A√ßƒ±k u√ßlu sorular i√ßin ≈üƒ±k gerekmez</p>';
            }
        }
        
        function collectQuestions() {
            const questions = [];
            const containers = document.querySelectorAll('[id^="question-"]');
            
            containers.forEach(container => {
                const text = container.querySelector('.question-text').value;
                const type = container.querySelector('.question-type').value;
                const explanation = container.querySelector('.question-explanation').value;
                
                if (!text) return;
                
                const question = { question: text, questionType: type, explanation: explanation };
                
                if (type === 'multiple-choice') {
                    question.options = [
                        container.querySelector('.option-a').value,
                        container.querySelector('.option-b').value,
                        container.querySelector('.option-c').value,
                        container.querySelector('.option-d').value
                    ];
                    question.correctAnswer = parseInt(container.querySelector('.correct-answer').value);
                } else if (type === 'fill-blank') {
                    const answers = container.querySelector('.correct-answers').value;
                    question.correctAnswers = answers.split(',').map(a => a.trim());
                }
                
                questions.push(question);
            });
            
            return questions;
        }
        
        async function handleSubmit(e) {
            e.preventDefault();
            try {
                const questions = collectQuestions();
                const pdfs = collectPDFs();

                const data = {
                    title: document.getElementById('videoTitle').value,
                    youtubeUrl: document.getElementById('youtubeUrl').value,
                    moduleId: document.getElementById('videoModule').value,
                    duration: parseInt(document.getElementById('videoDuration').value),
                    difficulty: document.getElementById('difficulty').value,
                    description: document.getElementById('videoDescription').value,
                    questions: questions,
                    pdfs: pdfs,
                    status: 'active'
                };

                console.log('üíæ Kaydedilecek veri:', data);
                console.log('üìÑ PDF sayƒ±sƒ±:', pdfs.length);

                let result;
                if (editingVideoId) {
                    // Update existing video
                    console.log('üîÑ Video g√ºncelleniyor, ID:', editingVideoId);
                    data.updatedAt = new Date().toISOString();
                    // IMPORTANT: Pass the ID as second parameter to update existing document
                    result = await window.DB.save('coordinatorVideos', data, editingVideoId);
                    if (result && result.success) {
                        console.log('‚úÖ Video g√ºncellendi:', editingVideoId);
                        alert('‚úÖ Video ba≈üarƒ±yla g√ºncellendi!');
                    }
                } else {
                    // Create new video
                    console.log('‚ûï Yeni video ekleniyor');
                    data.createdAt = new Date().toISOString();
                    result = await window.DB.save('coordinatorVideos', data);
                    if (result && result.success) {
                        console.log('‚úÖ Yeni video eklendi');
                        alert('‚úÖ Video, sorular ve PDF\'ler eklendi!');
                    }
                }

                if (result && result.success) {
                    // Clear form
                    document.getElementById('videoForm').reset();
                    document.getElementById('questions-container').innerHTML = '';
                    document.getElementById('pdf-inputs').innerHTML = '';
                    questionCount = 0;
                    pdfCount = 0;

                    // Reset edit mode
                    cancelEdit();

                    // Clear cache and reload videos
                    if (window.DB.clearCache) {
                        window.DB.clearCache('coordinatorVideos');
                    }
                    await loadVideos();
                } else {
                    throw new Error('Kayƒ±t ba≈üarƒ±sƒ±z');
                }
            } catch (e) {
                alert('‚ùå Hata: ' + e.message);
            }
        }
        
        async function deleteVideo(id) {
            if (!confirm('Bu videoyu kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?')) return;

            console.log('üóëÔ∏è Video siliniyor, ID:', id);

            try {
                // Delete directly from Firestore
                if (window.DB && window.DB.db) {
                    await window.DB.db.collection('coordinator_videos').doc(id).delete();
                    console.log('‚úÖ Video Firestore\'dan direkt silindi:', id);
                } else {
                    // Fallback to DB.delete
                    const deleteResult = await window.DB.delete('coordinatorVideos', id);
                    if (!deleteResult || !deleteResult.success) {
                        throw new Error('Video silinemedi');
                    }
                    console.log('‚úÖ Video DB.delete ile silindi:', id);
                }

                // Clear ALL caches aggressively
                if (window.DB) {
                    if (window.DB.clearCache) {
                        window.DB.clearCache('coordinatorVideos');
                    }
                    if (window.DB.cache) {
                        window.DB.cache.clear();
                    }
                }

                console.log('üîÑ Cache temizlendi');

                alert('‚úÖ Video ba≈üarƒ±yla silindi! Sayfa yenilenecek...');

                // Force reload the page to clear all caches
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);

            } catch (e) {
                console.error('‚ùå Video silme hatasƒ±:', e);
                alert('‚ùå Hata: ' + e.message);
            }
        }

        let editingVideoId = null;

        async function editVideo(id) {
            try {
                console.log('‚úèÔ∏è Video d√ºzenleniyor, ID:', id);
                editingVideoId = id;

                // Load specific video data by ID
                const result = await window.DB.load('coordinatorVideos', id);

                if (!result || !result.success || !result.data) {
                    alert('Video bulunamadƒ±');
                    console.error('‚ùå Video y√ºklenemedi:', id);
                    return;
                }

                const video = result.data;

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Fill form fields
                document.getElementById('videoModule').value = video.moduleId || '';
                document.getElementById('videoTitle').value = video.title || '';
                document.getElementById('videoDescription').value = video.description || '';
                document.getElementById('videoDuration').value = video.duration || '';
                document.getElementById('difficulty').value = video.difficulty || 'medium';
                document.getElementById('youtubeUrl').value = video.youtubeUrl || video.videoUrl || '';

                // Clear existing questions and PDFs
                document.getElementById('questions-container').innerHTML = '';
                document.getElementById('pdf-inputs').innerHTML = '';
                questionCount = 0;
                pdfCount = 0;

                // Load existing questions
                if (video.questions && video.questions.length > 0) {
                    console.log('üìù Sorular y√ºkleniyor:', video.questions.length);
                    video.questions.forEach(q => {
                        addQuestion();
                        const container = document.getElementById('question-' + questionCount);
                        if (container) {
                            container.querySelector('.question-text').value = q.question || '';
                            container.querySelector('.question-type').value = q.questionType || 'multiple-choice';
                            container.querySelector('.question-explanation').value = q.explanation || '';

                            if (q.questionType === 'multiple-choice' && q.options) {
                                container.querySelector('.option-a').value = q.options[0] || '';
                                container.querySelector('.option-b').value = q.options[1] || '';
                                container.querySelector('.option-c').value = q.options[2] || '';
                                container.querySelector('.option-d').value = q.options[3] || '';
                                container.querySelector('.correct-answer').value = q.correctAnswer || 0;
                            } else if (q.questionType === 'fill-blank' && q.correctAnswers) {
                                updateQuestionType(questionCount);
                                container.querySelector('.correct-answers').value = q.correctAnswers.join(', ');
                            }
                        }
                    });
                }

                // Load existing PDFs
                if (video.pdfs && video.pdfs.length > 0) {
                    console.log('üìÑ PDF\'ler y√ºkleniyor:', video.pdfs.length);
                    video.pdfs.forEach(pdf => {
                        addPDFInput();
                        document.getElementById(`pdf-title-${pdfCount}`).value = pdf.title || '';
                        document.getElementById(`pdf-url-${pdfCount}`).value = pdf.url || '';
                    });
                }

                // Change submit button to update mode
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Videoyu G√ºncelle';
                submitBtn.style.background = '#6366f1';

                // Add cancel button
                let cancelBtn = document.getElementById('cancel-edit-btn');
                if (!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.id = 'cancel-edit-btn';
                    cancelBtn.type = 'button';
                    cancelBtn.innerHTML = '<i class="fas fa-times mr-2"></i>ƒ∞ptal';
                    cancelBtn.style.cssText = 'background:#6b7280;color:white;padding:12px;border:none;border-radius:6px;cursor:pointer;font-size:14px;margin-left:10px;';
                    cancelBtn.onclick = cancelEdit;
                    submitBtn.parentNode.appendChild(cancelBtn);
                }

                alert('Video d√ºzenleme moduna alƒ±ndƒ±. A≈üaƒüƒ±daki formu d√ºzenleyin ve "Videoyu G√ºncelle" butonuna tƒ±klayƒ±n.');

            } catch (e) {
                alert('‚ùå Hata: ' + e.message);
            }
        }

        function cancelEdit() {
            console.log('‚ùå D√ºzenleme iptal edildi');
            editingVideoId = null;

            // Reset form
            document.getElementById('videoForm').reset();

            // Clear questions and PDFs
            document.getElementById('questions-container').innerHTML = '';
            document.getElementById('pdf-inputs').innerHTML = '';
            questionCount = 0;
            pdfCount = 0;

            // Reset submit button
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Videoyu Kaydet';
            submitBtn.style.background = '#6366f1';

            // Remove cancel button
            const cancelBtn = document.getElementById('cancel-edit-btn');
            if (cancelBtn) cancelBtn.remove();
        }

        // PDF Sistemi (URL ile - Basit)
        let pdfCount = 0;

        function addPDFInput() {
            pdfCount++;
            const container = document.getElementById('pdf-inputs');
            const div = document.createElement('div');
            div.id = `pdf-${pdfCount}`;
            div.style.cssText = 'margin-bottom:12px;padding:12px;background:white;border-radius:6px;border:1px solid #fecaca;';
            div.innerHTML = `
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span style="font-weight:600;color:#dc2626;">PDF #${pdfCount}</span>
                    <button type="button" onclick="removePDF(${pdfCount})" style="background:#fee2e2;color:#dc2626;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px;">
                        <i class="fas fa-times"></i> Sil
                    </button>
                </div>
                <input type="text" id="pdf-title-${pdfCount}" placeholder="PDF Ba≈ülƒ±ƒüƒ±" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;margin-bottom:8px;font-size:13px;">
                <input type="url" id="pdf-url-${pdfCount}" placeholder="PDF URL (Google Drive, Dropbox, vs.)" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;">
                <p style="font-size:11px;color:#6b7280;margin-top:4px;">
                    <i class="fas fa-link"></i> √ñrnek: https://drive.google.com/file/d/.../view
                </p>
            `;
            container.appendChild(div);
        }

        function removePDF(id) {
            const element = document.getElementById(`pdf-${id}`);
            if (element) element.remove();
        }

        function collectPDFs() {
            const pdfs = [];
            const container = document.getElementById('pdf-inputs');
            const pdfDivs = container.querySelectorAll('[id^="pdf-"]');

            pdfDivs.forEach(div => {
                const id = div.id.split('-')[1];
                const title = document.getElementById(`pdf-title-${id}`)?.value.trim();
                const url = document.getElementById(`pdf-url-${id}`)?.value.trim();

                if (title && url) {
                    pdfs.push({ title, url });
                }
            });

            return pdfs;
        }

        // Logout function
        function logout() {
            if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('loginTime');
                localStorage.removeItem('userRole');
                console.log('üö™ Koordinat√∂r √ßƒ±kƒ±≈üƒ± yapƒ±ldƒ±');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
