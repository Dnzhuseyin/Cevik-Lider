<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiriÅŸ Test - Debug</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ğŸ” GiriÅŸ Sistemi Debug</h1>

        <!-- Status -->
        <div id="firebase-status" class="mb-6 p-4 rounded-lg bg-gray-200">
            <h3 class="font-bold mb-2">Firebase Durum:</h3>
            <p id="firebase-info">Kontrol ediliyor...</p>
        </div>

        <!-- Test Buttons -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <button onclick="testFirebaseConnection()"
                class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700">
                Firebase BaÄŸlantÄ±sÄ±nÄ± Test Et
            </button>
            <button onclick="listAllUsers()"
                class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700">
                TÃ¼m KullanÄ±cÄ±larÄ± Listele
            </button>
            <button onclick="listAllCoordinators()"
                class="bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700">
                TÃ¼m KoordinatÃ¶rleri Listele
            </button>
            <button onclick="createTestStudent()"
                class="bg-yellow-600 text-white py-3 px-4 rounded-lg hover:bg-yellow-700">
                Test Ã–ÄŸrenci OluÅŸtur
            </button>
        </div>

        <!-- Results -->
        <div id="results" class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold mb-4 text-xl">SonuÃ§lar:</h3>
            <div id="results-content" class="font-mono text-sm whitespace-pre-wrap"></div>
        </div>

        <!-- Quick Login Forms -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <!-- Coordinator Login -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="font-bold mb-4">KoordinatÃ¶r Test GiriÅŸi</h3>
                <form id="coord-form" class="space-y-3">
                    <input type="email" id="coord-email" value="koordinator@ceviklider.com"
                        class="w-full px-3 py-2 border rounded">
                    <input type="password" id="coord-password" value="CevikLider2024!"
                        class="w-full px-3 py-2 border rounded">
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                        KoordinatÃ¶r GiriÅŸi Test Et
                    </button>
                </form>
            </div>

            <!-- Student Login -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="font-bold mb-4">Ã–ÄŸrenci Test GiriÅŸi</h3>
                <form id="student-form" class="space-y-3">
                    <input type="email" id="student-email" value="test@student.com"
                        class="w-full px-3 py-2 border rounded">
                    <input type="password" id="student-password" value="test123"
                        class="w-full px-3 py-2 border rounded">
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                        Ã–ÄŸrenci GiriÅŸi Test Et
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="js/firebase-production.js"></script>

    <script>
        function log(message, isError = false) {
            const content = document.getElementById('results-content');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = isError ? 'âŒ' : 'âœ…';
            content.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            console.log(message);
        }

        async function waitForFirebase() {
            log('Firebase bekleniyor...');
            let attempts = 0;
            while ((!window.DB || !window.DB.isFirebaseReady) && attempts < 100) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }

            if (!window.DB || !window.DB.isFirebaseReady) {
                throw new Error('Firebase baÅŸlatÄ±lamadÄ±!');
            }

            log('Firebase hazÄ±r!');
        }

        async function testFirebaseConnection() {
            document.getElementById('results-content').textContent = '';
            try {
                log('Firebase baÄŸlantÄ±sÄ± test ediliyor...');
                await waitForFirebase();

                // Try to read a collection
                const result = await window.DB.load('userProfiles');
                log('Firestore okuma testi BAÅARILI');
                log(`userProfiles koleksiyonunda ${result?.data?.length || 0} kayÄ±t bulundu`);

            } catch (error) {
                log('Firebase baÄŸlantÄ± hatasÄ±: ' + error.message, true);
            }
        }

        async function listAllUsers() {
            document.getElementById('results-content').textContent = '';
            try {
                await waitForFirebase();
                log('Ã–ÄŸrenciler yÃ¼kleniyor...');

                const result = await window.DB.load('userProfiles');
                const users = (result && result.success && Array.isArray(result.data)) ? result.data : [];

                log(`Toplam ${users.length} Ã¶ÄŸrenci bulundu:`);
                users.forEach((user, index) => {
                    log(`${index + 1}. ${user.userEmail} - ${user.firstName || 'Ä°sim yok'} ${user.lastName || ''}`);
                    if (user.password) {
                        log(`   Åifre: ${user.password}`);
                    }
                });

                if (users.length === 0) {
                    log('âš ï¸ HiÃ§ Ã¶ÄŸrenci kaydÄ± bulunamadÄ±!', true);
                }

            } catch (error) {
                log('Ã–ÄŸrenciler yÃ¼klenemedi: ' + error.message, true);
            }
        }

        async function listAllCoordinators() {
            document.getElementById('results-content').textContent = '';
            try {
                await waitForFirebase();
                log('KoordinatÃ¶rler yÃ¼kleniyor...');

                const result = await window.DB.load('coordinatorProfiles');
                const coordinators = (result && result.success && Array.isArray(result.data)) ? result.data : [];

                log(`Toplam ${coordinators.length} koordinatÃ¶r bulundu:`);
                coordinators.forEach((coord, index) => {
                    log(`${index + 1}. ${coord.userEmail} - ${coord.firstName || 'Ä°sim yok'} ${coord.lastName || ''}`);
                    if (coord.password) {
                        log(`   Åifre: ${coord.password}`);
                    }
                    log(`   Aktif: ${coord.isActive !== false ? 'Evet' : 'HayÄ±r'}`);
                });

                if (coordinators.length === 0) {
                    log('âš ï¸ HiÃ§ koordinatÃ¶r kaydÄ± bulunamadÄ±!', true);
                    log('ğŸ“ create-coordinator.html sayfasÄ±nÄ± kullanarak koordinatÃ¶r oluÅŸturun');
                }

            } catch (error) {
                log('KoordinatÃ¶rler yÃ¼klenemedi: ' + error.message, true);
            }
        }

        async function createTestStudent() {
            document.getElementById('results-content').textContent = '';
            try {
                await waitForFirebase();
                log('Test Ã¶ÄŸrenci oluÅŸturuluyor...');

                const testStudent = {
                    userEmail: 'test@student.com',
                    password: 'test123',
                    firstName: 'Test',
                    lastName: 'Ã–ÄŸrenci',
                    role: 'student',
                    department: 'Test DepartmanÄ±',
                    createdAt: new Date().toISOString(),
                    isActive: true
                };

                const result = await window.DB.save('userProfiles', testStudent);

                if (result && result.success) {
                    log('Test Ã¶ÄŸrenci baÅŸarÄ±yla oluÅŸturuldu!');
                    log(`Email: ${testStudent.userEmail}`);
                    log(`Åifre: ${testStudent.password}`);
                } else {
                    throw new Error('KayÄ±t baÅŸarÄ±sÄ±z');
                }

            } catch (error) {
                log('Test Ã¶ÄŸrenci oluÅŸturulamadÄ±: ' + error.message, true);
            }
        }

        // Test login forms
        document.getElementById('coord-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('results-content').textContent = '';

            const email = document.getElementById('coord-email').value;
            const password = document.getElementById('coord-password').value;

            try {
                log(`KoordinatÃ¶r giriÅŸi test ediliyor: ${email}`);
                await waitForFirebase();

                const result = await window.DB.load('coordinatorProfiles');
                const coordinators = (result && result.success && Array.isArray(result.data)) ? result.data : [];

                log(`VeritabanÄ±nda ${coordinators.length} koordinatÃ¶r bulundu`);

                const coordinator = coordinators.find(c => c.userEmail === email);

                if (!coordinator) {
                    log('KoordinatÃ¶r hesabÄ± bulunamadÄ±!', true);
                    log('Mevcut koordinatÃ¶rler:', true);
                    coordinators.forEach(c => log(`  - ${c.userEmail}`, true));
                    return;
                }

                log('KoordinatÃ¶r bulundu!');
                log(`Åifre kontrolÃ¼: DB ÅŸifresi="${coordinator.password}" vs Girilen="${password}"`);

                if (coordinator.password && coordinator.password !== password) {
                    log('Åifre yanlÄ±ÅŸ!', true);
                    return;
                }

                log('GÄ°RÄ°Å BAÅARILI! âœ…');

            } catch (error) {
                log('Hata: ' + error.message, true);
            }
        });

        document.getElementById('student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('results-content').textContent = '';

            const email = document.getElementById('student-email').value;
            const password = document.getElementById('student-password').value;

            try {
                log(`Ã–ÄŸrenci giriÅŸi test ediliyor: ${email}`);
                await waitForFirebase();

                const result = await window.DB.load('userProfiles');
                const users = (result && result.success && Array.isArray(result.data)) ? result.data : [];

                log(`VeritabanÄ±nda ${users.length} Ã¶ÄŸrenci bulundu`);

                const user = users.find(u => u.userEmail === email);

                if (!user) {
                    log('Ã–ÄŸrenci hesabÄ± bulunamadÄ±!', true);
                    log('Ã–nce "Test Ã–ÄŸrenci OluÅŸtur" butonuna tÄ±klayÄ±n', true);
                    return;
                }

                log('Ã–ÄŸrenci bulundu!');
                log(`Åifre kontrolÃ¼: DB ÅŸifresi="${user.password}" vs Girilen="${password}"`);

                if (user.password && user.password !== password) {
                    log('Åifre yanlÄ±ÅŸ!', true);
                    return;
                }

                log('GÄ°RÄ°Å BAÅARILI! âœ…');

            } catch (error) {
                log('Hata: ' + error.message, true);
            }
        });

        // Check Firebase status on load
        document.addEventListener('DOMContentLoaded', async () => {
            const statusEl = document.getElementById('firebase-info');

            try {
                await waitForFirebase();
                statusEl.innerHTML = 'âœ… Firebase baÄŸlantÄ±sÄ± BAÅARILI';
                statusEl.parentElement.className = 'mb-6 p-4 rounded-lg bg-green-100 text-green-800';
            } catch (error) {
                statusEl.innerHTML = 'âŒ Firebase baÄŸlantÄ±sÄ± BAÅARISIZ: ' + error.message;
                statusEl.parentElement.className = 'mb-6 p-4 rounded-lg bg-red-100 text-red-800';
            }
        });
    </script>
</body>
</html>
