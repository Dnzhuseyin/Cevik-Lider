<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Ã–ÄŸrenci YÃ¶netimi - Ã‡evik Lider Admin</title>
    <!-- Authentication Guard -->
    <script src="js/auth-guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#dc2626',
                        accent: '#059669',
                        cyber: '#6366f1',
                        dark: '#0f172a'
                    }
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="js/firebase-production.js?v=20241121002"></script>
    <script src="js/user-utils.js"></script>
    <style>
        /* ULTRA STRONG SIDEBAR FIX - NEVER DISAPPEAR */
        .sidebar-container {
            position: fixed !important;
            left: 0 !important;
            top: 0 !important;
            width: 256px !important;
            height: 100vh !important;
            z-index: 999999 !important;
            background-color: #0f172a !important;
            overflow-y: auto !important;
            transform: none !important;
            will-change: auto !important;
            pointer-events: auto !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .main-content {
            margin-left: 256px !important;
            z-index: 1 !important;
            position: relative !important;
        }
        
        /* Force sidebar to stay visible - ULTRA STRONG */
        body > aside {
            position: fixed !important;
            z-index: 999999 !important;
            left: 0 !important;
            top: 0 !important;
            height: 100vh !important;
            overflow-y: auto !important;
            transform: none !important;
            will-change: auto !important;
            pointer-events: auto !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Additional safety measures */
        aside.sidebar-container {
            position: fixed !important;
            z-index: 999999 !important;
            left: 0 !important;
            top: 0 !important;
            height: 100vh !important;
            overflow-y: auto !important;
            transform: none !important;
            will-change: auto !important;
            pointer-events: auto !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Sidebar - ULTRA STRONG FIXED - NEVER DISAPPEAR -->
    <aside class="sidebar-container bg-dark text-white w-64 min-h-screen hidden md:block">
        <div class="p-4">
            <a href="instructor-dashboard.html" class="font-bold text-xl text-secondary block mb-8 flex items-center">
                <i class="fas fa-graduation-cap text-2xl mr-3"></i>
                Ã‡evik Lider Admin
            </a>
            
            <div class="mb-8">
                <div class="flex items-center mb-4">
                    <div>
                        <p class="font-medium" id="instructor-name"></p>
                        <p class="text-sm text-gray-400" id="instructor-email"></p>
                    </div>
                </div>
            </div>
            
            <nav class="space-y-1">
                <a href="instructor-dashboard.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span>Genel BakÄ±ÅŸ</span>
                </a>
                <a href="instructor-courses.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-graduation-cap mr-3"></i>
                    <span>EÄŸitim ModÃ¼lleri</span>
                </a>
                <a href="instructor-content.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-video mr-3"></i>
                    <span>Video YÃ¶netimi</span>
                </a>
                <a href="instructor-students.html" class="flex items-center px-4 py-3 rounded-lg bg-slate-800">
                    <i class="fas fa-users mr-3 text-secondary"></i>
                    <span>Ã–ÄŸrenci YÃ¶netimi</span>
                </a>
            </nav>

            <div class="absolute bottom-0 left-0 w-full p-4 border-t border-slate-800">
                <button onclick="logout()" class="flex items-center text-gray-400 hover:text-white w-full text-left bg-transparent border-none">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    <span>Ã‡Ä±kÄ±ÅŸ Yap</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main content -->
    <main class="main-content p-4 md:p-8 w-full min-h-screen">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">Ã–ÄŸrenci YÃ¶netimi</h1>
                        <p class="text-gray-600">EÄŸitim alan Ã¶ÄŸrencileri yÃ¶netin ve takip edin</p>
                    </div>
                    <button class="bg-cyber text-white px-4 py-2 rounded-lg flex items-center" id="add-student">
                        <i class="fas fa-user-plus mr-2"></i>
                        Yeni Ã–ÄŸrenci Ekle
                    </button>
                </div>
            </header>

            <!-- Student Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-600">Toplam Ã–ÄŸrenci</h3>
                        <div class="h-10 w-10 bg-cyber/10 text-cyber rounded-lg flex items-center justify-center">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-gray-900" id="total-students">0</p>
                    <p class="text-xs text-gray-500 mt-1">kayÄ±tlÄ± Ã¶ÄŸrenci</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-600">Aktif Ã–ÄŸrenci</h3>
                        <div class="h-10 w-10 bg-accent/10 text-accent rounded-lg flex items-center justify-center">
                            <i class="fas fa-user-check"></i>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-gray-900" id="active-students">0</p>
                    <p class="text-xs text-gray-500 mt-1">son 7 gÃ¼n aktif</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-600">Ortalama Ä°lerleme</h3>
                        <div class="h-10 w-10 bg-primary/10 text-primary rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-gray-900" id="avg-progress">0%</p>
                    <p class="text-xs text-gray-500 mt-1">tÃ¼m Ã¶ÄŸrenciler</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-600">BaÅŸarÄ± OranÄ±</h3>
                        <div class="h-10 w-10 bg-secondary/10 text-secondary rounded-lg flex items-center justify-center">
                            <i class="fas fa-trophy"></i>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-gray-900" id="success-rate">0%</p>
                    <p class="text-xs text-gray-500 mt-1">modÃ¼l tamamlama</p>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8 border border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Arama</label>
                        <input type="text" placeholder="Ã–ÄŸrenci ara..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent"
                               id="search-students">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ä°lerleme</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent"
                                id="filter-progress">
                            <option value="">TÃ¼m Ã–ÄŸrenciler</option>
                            <option value="high">YÃ¼ksek Ä°lerleme (>75%)</option>
                            <option value="medium">Orta Ä°lerleme (25-75%)</option>
                            <option value="low">DÃ¼ÅŸÃ¼k Ä°lerleme (<25%)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SÄ±ralama</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent"
                                id="sort-students">
                            <option value="name">Ä°sim</option>
                            <option value="progress">Ä°lerleme</option>
                            <option value="lastActivity">Son Aktivite</option>
                            <option value="registrationDate">KayÄ±t Tarihi</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Students Table -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold flex items-center">
                        <i class="fas fa-table text-primary mr-2"></i>
                        Ã–ÄŸrenci Listesi
                    </h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ã–ÄŸrenci</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ä°lerleme</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Son Aktivite</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="students-table-body">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Student Detail Modal -->
    <div id="student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-gray-900">Ã–ÄŸrenci DetaylarÄ±</h3>
                <button onclick="closeStudentModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="student-detail-content">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="add-student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-gray-900">Yeni Ã–ÄŸrenci Ekle</h3>
                <button onclick="closeAddStudentModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="add-student-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ad</label>
                        <input type="text" id="student-firstname" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Soyad</label>
                        <input type="text" id="student-lastname" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">E-posta</label>
                    <input type="email" id="student-email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Åifre</label>
                    <input type="password" id="student-password" required minlength="6"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">Minimum 6 karakter</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ã–ÄŸrenci No (Opsiyonel)</label>
                    <input type="text" id="student-id"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeAddStudentModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Ä°ptal
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-cyber text-white rounded-lg hover:bg-cyber/90">
                        <i class="fas fa-user-plus mr-2"></i>Ã–ÄŸrenci Ekle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allStudents = [];
        let filteredStudents = [];

        // Page initialization
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize user info using UserUtils
            await UserUtils.initializeUserInfo();
            
            // Update coordinator-specific display names
            const userEmail = localStorage.getItem('userEmail');
            if (userEmail) {
                const userName = userEmail.split('@')[0];
                const displayName = 'KoordinatÃ¶r ' + userName.charAt(0).toUpperCase() + userName.slice(1);
                
                // Desktop sidebar gÃ¼ncelle
                const instructorNameEl = document.getElementById('instructor-name');
                const instructorEmailEl = document.getElementById('instructor-email');
                
                if (instructorNameEl) instructorNameEl.textContent = displayName;
                if (instructorEmailEl) instructorEmailEl.textContent = '';
            }
            
            await loadStudents();
            setupEventListeners();
        });

        // Load students from Firebase
        async function loadStudents() {
            try {
                console.log('ğŸ“š Ã–ÄŸrenci verileri yÃ¼kleniyor...');
                
                // Wait for DB to be ready
                if (!window.DB) {
                    console.warn('âš ï¸ DB henÃ¼z hazÄ±r deÄŸil, bekleniyor...');
                    await new Promise(resolve => {
                        const checkDB = () => {
                            if (window.DB) {
                                resolve();
                            } else {
                                setTimeout(checkDB, 100);
                            }
                        };
                        checkDB();
                    });
                }
                
                // Load all user data from Firebase
                let userProfilesData = [];
                let progressData = [];
                let notesData = [];
                let videosData = [];
                
                try {
                    // Load user profiles (registered students)
                    const userProfilesResult = await DB.load('userProfiles');
                    userProfilesData = (userProfilesResult && userProfilesResult.success) ? userProfilesResult.data : [];
                    console.log('âœ… User profiles yÃ¼klendi:', userProfilesData.length);
                } catch (error) {
                    console.warn('âš ï¸ User profiles yÃ¼klenemedi:', error);
                    userProfilesData = [];
                }
                
                try {
                    const progressResult = await DB.load('userProgress');
                    progressData = (progressResult && progressResult.success) ? progressResult.data : [];
                    console.log('âœ… Progress data yÃ¼klendi:', progressData.length);
                } catch (error) {
                    console.warn('âš ï¸ Progress data yÃ¼klenemedi:', error);
                    progressData = [];
                }
                
                try {
                    const notesResult = await DB.load('userNotes');
                    notesData = (notesResult && notesResult.success) ? notesResult.data : [];
                    console.log('âœ… Notes data yÃ¼klendi:', notesData.length);
                } catch (error) {
                    console.warn('âš ï¸ Notes data yÃ¼klenemedi:', error);
                    notesData = [];
                }
                
                try {
                    const videosResult = await DB.load('studentVideos');
                    videosData = (videosResult && videosResult.success) ? videosResult.data : [];
                    console.log('âœ… Videos data yÃ¼klendi:', videosData.length);
                } catch (error) {
                    console.warn('âš ï¸ Videos data yÃ¼klenemedi:', error);
                    videosData = [];
                }

                // Load modules to get total count
                let totalModules = 0;
                try {
                    const modulesResult = await DB.loadModules();
                    const modulesData = (modulesResult && modulesResult.success) ? modulesResult.data : [];
                    totalModules = modulesData.length;
                    console.log('âœ… Total modules:', totalModules);
                } catch (error) {
                    console.warn('âš ï¸ Modules data yÃ¼klenemedi:', error);
                    totalModules = 0;
                }
                
                // Ensure data is array
                if (!Array.isArray(userProfilesData)) {
                    console.warn('âš ï¸ User profiles data array deÄŸil, dÃ¼zeltiliyor');
                    userProfilesData = [];
                }
                
                if (!Array.isArray(progressData)) {
                    console.warn('âš ï¸ Progress data array deÄŸil, dÃ¼zeltiliyor');
                    progressData = [];
                }
                
                if (!Array.isArray(notesData)) {
                    console.warn('âš ï¸ Notes data array deÄŸil, dÃ¼zeltiliyor');
                    notesData = [];
                }
                
                if (!Array.isArray(videosData)) {
                    console.warn('âš ï¸ Videos data array deÄŸil, dÃ¼zeltiliyor');
                    videosData = [];
                }
                
                // Create student list from user profiles
                const studentMap = new Map();
                
                // Process user profiles (main student data)
                userProfilesData.forEach(profile => {
                    try {
                        const email = profile.userEmail;
                        if (email && !email.includes('koordinator') && !email.includes('instructor')) {
                            const fullName = `${profile.firstName || ''} ${profile.lastName || ''}`.trim();
                            
                            studentMap.set(email, {
                                id: email,
                                email: email,
                                name: fullName || extractNameFromEmail(email),
                                firstName: profile.firstName || '',
                                lastName: profile.lastName || '',
                                studentId: profile.studentId || '',
                                phone: profile.phone || '',
                                bio: profile.bio || '',
                                totalProgress: 0,
                                completedModules: 0,
                                totalModules: totalModules,
                                lastActivity: profile.updatedAt || profile.createdAt || new Date().toISOString(),
                                joinDate: profile.joinDate || profile.createdAt || new Date().toISOString(),
                                isActive: false,
                                moduleProgress: {},
                                notes: 0,
                                completedVideos: 0
                            });
                        }
                    } catch (profileError) {
                        console.warn('âš ï¸ Profile item iÅŸlenirken hata:', profileError);
                    }
                });

                // Update progress data
                progressData.forEach(progress => {
                    try {
                        const email = progress.userEmail || progress.email;
                        if (email && studentMap.has(email)) {
                            const student = studentMap.get(email);
                            
                            // Update progress
                            if (progress.moduleId && progress.completionRate !== undefined) {
                                // Store module-specific progress
                                student.moduleProgress[progress.moduleId] = progress.completionRate;
                            }

                            if (progress.moduleProgress) {
                                student.moduleProgress = { ...student.moduleProgress, ...progress.moduleProgress };
                            }

                            // Update last activity
                            if (progress.lastActivity) {
                                student.lastActivity = progress.lastActivity;
                            }

                            // Calculate total progress
                            const moduleKeys = Object.keys(student.moduleProgress);
                            if (moduleKeys.length > 0) {
                                student.totalProgress = Math.round(
                                    moduleKeys.reduce((sum, key) => sum + (student.moduleProgress[key] || 0), 0) / moduleKeys.length
                                );
                                student.completedModules = moduleKeys.filter(key => student.moduleProgress[key] >= 100).length;
                            }

                            // Check if recently active
                            student.isActive = isRecentlyActive(student.lastActivity);
                        }
                    } catch (progressError) {
                        console.warn('âš ï¸ Progress item iÅŸlenirken hata:', progressError);
                    }
                });

                // Update notes count
                notesData.forEach(note => {
                    try {
                        const email = note.userEmail;
                        if (email && studentMap.has(email)) {
                            const student = studentMap.get(email);
                            student.notes++;
                        }
                    } catch (noteError) {
                        console.warn('âš ï¸ Note item iÅŸlenirken hata:', noteError);
                    }
                });

                // Update completed videos count
                videosData.forEach(video => {
                    try {
                        const email = video.userEmail;
                        if (email && studentMap.has(email) && video.isCompleted) {
                            const student = studentMap.get(email);
                            student.completedVideos++;
                        }
                    } catch (videoError) {
                        console.warn('âš ï¸ Video item iÅŸlenirken hata:', videoError);
                    }
                });

                // Convert map to array
                allStudents = Array.from(studentMap.values());
                
                // No default students - only show real registered students
                console.log(`âœ… ${allStudents.length} gerÃ§ek Ã¶ÄŸrenci yÃ¼klendi`);
                filteredStudents = [...allStudents];
                
                console.log('âœ… Ã–ÄŸrenci verileri baÅŸarÄ±yla yÃ¼klendi:', allStudents.length);
                
                updateStats();
                renderStudentsTable();
                
            } catch (error) {
                console.error('âŒ Ã–ÄŸrenci yÃ¼kleme hatasÄ±:', error);
                showError('Ã–ÄŸrenci verileri yÃ¼klenirken hata oluÅŸtu: ' + error.message);
                
                // Show fallback message
                const tbody = document.getElementById('students-table-body');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center">
                                <div class="text-gray-500">
                                    <i class="fas fa-exclamation-triangle text-4xl mb-4 text-yellow-500"></i>
                                    <p class="text-lg font-medium mb-2">Veri YÃ¼kleme HatasÄ±</p>
                                    <p class="text-sm">Ã–ÄŸrenci verileri yÃ¼klenirken bir hata oluÅŸtu.</p>
                                    <button onclick="loadStudents()" class="mt-4 bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90">
                                        Tekrar Dene
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // No default students - only real registered users will be shown
        async function createSampleStudents() {
            // Default students disabled - only real registered users will be shown
            console.log('â„¹ï¸ Default Ã¶ÄŸrenci oluÅŸturma atlandÄ± - sadece gerÃ§ek kayÄ±tlÄ± kullanÄ±cÄ±lar gÃ¶sterilecek');
        }

        // Helper functions
        function extractNameFromEmail(email) {
            const name = email.split('@')[0];
            return name.split('.').map(part => 
                part.charAt(0).toUpperCase() + part.slice(1)
            ).join(' ');
        }

        function isRecentlyActive(lastActivity) {
            if (!lastActivity) return false;
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            return new Date(lastActivity) > oneWeekAgo;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('tr-TR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatRelativeTime(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffInHours < 24) {
                return `${diffInHours} saat Ã¶nce`;
            } else if (diffInHours < 24 * 7) {
                return `${Math.floor(diffInHours / 24)} gÃ¼n Ã¶nce`;
            } else {
                return formatDate(dateString);
            }
        }

        // Update statistics
        function updateStats() {
            document.getElementById('total-students').textContent = allStudents.length;
            document.getElementById('active-students').textContent = allStudents.filter(s => s.isActive).length;
            document.getElementById('avg-progress').textContent = allStudents.length > 0 
                ? Math.round(allStudents.reduce((sum, s) => sum + s.totalProgress, 0) / allStudents.length) + '%'
                : '0%';
            
            const successRate = allStudents.length > 0 && allStudents[0]?.totalModules > 0
                ? Math.round((allStudents.reduce((sum, s) => sum + s.completedModules, 0) / (allStudents.length * allStudents[0].totalModules)) * 100)
                : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
        }

        // Render students table
        function renderStudentsTable() {
            const tbody = document.getElementById('students-table-body');
            
            if (filteredStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="text-gray-500">
                                <i class="fas fa-users text-4xl mb-4"></i>
                                <p class="text-lg font-medium mb-2">HenÃ¼z Ã¶ÄŸrenci bulunmuyor</p>
                                <p class="text-sm">Ã–ÄŸrenciler kayÄ±t oldukÃ§a burada gÃ¶rÃ¼necekler.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredStudents.map(student => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-full bg-gradient-to-r from-cyber to-primary text-white flex items-center justify-center font-medium text-sm mr-3">
                                ${student.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${student.name}</div>
                                <div class="text-sm text-gray-500">${student.email}</div>
                                ${student.studentId ? `<div class="text-xs text-gray-400">${student.studentId}</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-16 bg-gray-200 rounded-full h-2 mr-3">
                                <div class="bg-gradient-to-r from-cyber to-primary h-2 rounded-full" style="width: ${student.totalProgress}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-900">${student.totalProgress}%</span>
                        </div>
                        <div class="text-sm text-gray-500">${student.completedModules}/${student.totalModules} modÃ¼l</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatRelativeTime(student.lastActivity)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            student.isActive 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-gray-100 text-gray-800'
                        }">
                            ${student.isActive ? 'Aktif' : 'Pasif'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex gap-2">
                            <button onclick="viewStudentDetail('${student.id}')" class="text-cyber hover:text-primary">
                                <i class="fas fa-eye"></i> Detay
                            </button>
                            <button onclick="deleteStudent('${student.id}', '${student.name}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i> Sil
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Get department name
        function getDepartmentName(departmentCode) {
            const departments = {
                'bilgisayar-muhendisligi': 'Bilgisayar MÃ¼hendisliÄŸi',
                'bilisim-sistemleri': 'BiliÅŸim Sistemleri',
                'bilgisayar-bilimleri': 'Bilgisayar Bilimleri',
                'yazilim-muhendisligi': 'YazÄ±lÄ±m MÃ¼hendisliÄŸi',
                'bilgisayar-programciligi': 'Bilgisayar ProgramcÄ±lÄ±ÄŸÄ±'
            };
            return departments[departmentCode] || departmentCode || 'BelirtilmemiÅŸ';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            const searchStudents = document.getElementById('search-students');
            if (searchStudents) {
                searchStudents.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    filteredStudents = allStudents.filter(student =>
                        student.name.toLowerCase().includes(searchTerm) ||
                        student.email.toLowerCase().includes(searchTerm)
                    );
                    renderStudentsTable();
                });
            }

            // Progress filter
            const filterProgress = document.getElementById('filter-progress');
            if (filterProgress) {
                filterProgress.addEventListener('change', function(e) {
                    const filter = e.target.value;
                    filteredStudents = allStudents.filter(student => {
                        if (!filter) return true;
                        if (filter === 'high') return student.totalProgress > 75;
                        if (filter === 'medium') return student.totalProgress >= 25 && student.totalProgress <= 75;
                        if (filter === 'low') return student.totalProgress < 25;
                        return true;
                    });
                    renderStudentsTable();
                });
            }

            // Sort students
            const sortStudents = document.getElementById('sort-students');
            if (sortStudents) {
                sortStudents.addEventListener('change', function(e) {
                    const sortBy = e.target.value;
                    filteredStudents.sort((a, b) => {
                        switch (sortBy) {
                            case 'name':
                                return a.name.localeCompare(b.name);
                            case 'progress':
                                return b.totalProgress - a.totalProgress;
                            case 'lastActivity':
                                return new Date(b.lastActivity) - new Date(a.lastActivity);
                            case 'registrationDate':
                                return new Date(b.joinDate) - new Date(a.joinDate);
                            default:
                                return 0;
                        }
                    });
                    renderStudentsTable();
                });
            }

            // Add student button
            const addStudentBtn = document.getElementById('add-student');
            if (addStudentBtn) {
                addStudentBtn.addEventListener('click', openAddStudentModal);
            }

            // Add student form
            const addStudentForm = document.getElementById('add-student-form');
            if (addStudentForm) {
                addStudentForm.addEventListener('submit', handleAddStudent);
            }

            // Logout functionality
            document.querySelectorAll('a[href="index.html"]').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();

                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('loginTime');

                    console.log('KoordinatÃ¶r Ã§Ä±kÄ±ÅŸÄ± yapÄ±ldÄ±');
                    window.location.href = 'index.html';
                });
            });
        }

        // Delete student function
        async function deleteStudent(studentId, studentName) {
            if (!confirm(`"${studentName}" adlÄ± Ã¶ÄŸrenciyi kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz ve Ã¶ÄŸrencinin tÃ¼m verileri (ilerleme, notlar, cevaplar) silinecektir.`)) {
                return;
            }

            try {
                console.log('ğŸ—‘ï¸ Ã–ÄŸrenci siliniyor:', studentId, studentName);
                
                // Show loading
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                loadingDiv.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600 mr-3"></div>
                            <span class="text-lg">Ã–ÄŸrenci siliniyor...</span>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingDiv);

                // Delete from all collections
                const collections = [
                    'userProfiles',
                    'userProgress', 
                    'userNotes',
                    'videoQuestionAnswers',
                    'quizResponses'
                ];

                let deletedCount = 0;
                
                for (const collection of collections) {
                    try {
                        console.log(`ğŸ” ${collection} koleksiyonunda ${studentId} aranÄ±yor...`);
                        
                        const result = await window.DB.load(collection);
                        if (result && result.success) {
                            const allData = Array.isArray(result.data) ? result.data : Object.values(result.data || {});
                            
                            // Find records for this student
                            const studentRecords = allData.filter(record => {
                                return record.id === studentId || 
                                       record.userId === studentId || 
                                       record.userEmail === studentId ||
                                       (record.email && record.email === studentId);
                            });
                            
                            console.log(`ğŸ“Š ${collection}: ${studentRecords.length} kayÄ±t bulundu`);
                            
                            // Delete each record
                            for (const record of studentRecords) {
                                const deleteResult = await window.DB.delete(collection, record.id || record.userId || studentId);
                                if (deleteResult && deleteResult.success) {
                                    deletedCount++;
                                    console.log(`âœ… ${collection}/${record.id || record.userId || studentId} silindi`);
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`âŒ ${collection} silme hatasÄ±:`, error);
                    }
                }

                loadingDiv.remove();
                
                console.log(`âœ… Toplam ${deletedCount} kayÄ±t silindi`);
                alert(`âœ… "${studentName}" adlÄ± Ã¶ÄŸrenci ve tÃ¼m verileri baÅŸarÄ±yla silindi!\n\nSilinen kayÄ±t sayÄ±sÄ±: ${deletedCount}`);
                
                // Reload students list
                await loadStudents();
                
            } catch (error) {
                console.error('âŒ Ã–ÄŸrenci silme hatasÄ±:', error);
                alert('âŒ Ã–ÄŸrenci silinirken hata oluÅŸtu: ' + error.message);
                
                // Remove loading if exists
                const loadingDiv = document.querySelector('.fixed.inset-0');
                if (loadingDiv) loadingDiv.remove();
            }
        }

        // View student detail
        async function viewStudentDetail(studentId) {
            console.log('ğŸ” viewStudentDetail Ã§aÄŸrÄ±ldÄ±:', studentId);
            console.log('ğŸ“Š allStudents:', allStudents.length, 'Ã¶ÄŸrenci');
            console.log('ğŸ“Š allStudents array:', allStudents);
            
            // Force alert to check if function is called
            alert(`ğŸ” viewStudentDetail Ã§aÄŸrÄ±ldÄ±! ID: ${studentId}, Ã–ÄŸrenci sayÄ±sÄ±: ${allStudents.length}`);
            
            // Debug: Show all student IDs
            allStudents.forEach((s, index) => {
                console.log(`Student ${index}: ID="${s.id}", Email="${s.email}", Name="${s.name}"`);
            });
            
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                console.error('âŒ Ã–ÄŸrenci bulunamadÄ±:', studentId);
                console.error('âŒ Aranan ID:', studentId, 'Tip:', typeof studentId);
                alert('âŒ Ã–ÄŸrenci bulunamadÄ±: ' + studentId);
                return;
            }

            console.log('âœ… Ã–ÄŸrenci bulundu:', student.name);
            console.log('ğŸ“Š Ã–ÄŸrenci verileri:', student);
            console.log('ğŸ“Š Module Progress:', student.moduleProgress);

            const modal = document.getElementById('student-modal');
            const content = document.getElementById('student-detail-content');
            
            if (!modal) {
                console.error('âŒ Modal bulunamadÄ±');
                alert('âŒ Modal element bulunamadÄ±!');
                return;
            }
            
            if (!content) {
                console.error('âŒ Content bulunamadÄ±');
                alert('âŒ Content element bulunamadÄ±!');
                return;
            }
            
            // Show loading
            content.innerHTML = `
                <div class="flex items-center justify-center py-12">
                    <div class="w-10 h-10 border-4 border-cyber border-t-transparent rounded-full animate-spin mr-4"></div>
                    <span class="text-lg text-gray-600">Ã–ÄŸrenci detaylarÄ± yÃ¼kleniyor...</span>
                </div>
            `;
            modal.classList.remove('hidden');
            
            console.log('ğŸ¯ Modal aÃ§Ä±lÄ±yor...');
            
            try {
                // Fetch modules for module names
                const modulesResult = await DB.loadModules();
                const allModules = modulesResult.success ? modulesResult.data : [];
                const moduleMap = {};
                allModules.forEach(module => {
                    moduleMap[module.id] = module.title || module.name || 'Ä°simsiz ModÃ¼l';
                });
                console.log('ğŸ“š ModÃ¼l isimleri yÃ¼klendi:', moduleMap);

                // Fetch video question answers
                const videoQuestionAnswersResult = await DB.load('videoQuestionAnswers');
                console.log('ğŸ“¦ Raw videoQuestionAnswers result:', videoQuestionAnswersResult);

                // Filter with multiple possible email fields and case-insensitive matching
                const studentEmailLower = student.email.toLowerCase();
                const videoQuestionAnswers = videoQuestionAnswersResult.success ?
                    videoQuestionAnswersResult.data.filter(a => {
                        const answerEmail = (a.userEmail || a.email || '').toLowerCase();
                        return answerEmail === studentEmailLower;
                    }) : [];

                console.log(`ğŸ“ ${videoQuestionAnswers.length} video soru cevabÄ± bulundu for ${student.email}`);
                console.log('ğŸ“ All videoQuestionAnswers count:', videoQuestionAnswersResult.success ? videoQuestionAnswersResult.data.length : 0);

                // Debug: Show all unique emails in videoQuestionAnswers
                if (videoQuestionAnswersResult.success) {
                    const allEmails = [...new Set(videoQuestionAnswersResult.data.map(a => a.userEmail || a.email))];
                    console.log('ğŸ“§ All unique emails in answers:', allEmails);
                    console.log('ğŸ“§ Looking for:', student.email);

                    // Show sample answers for this student
                    const matchingByUserEmail = videoQuestionAnswersResult.data.filter(a =>
                        a.userEmail && a.userEmail.toLowerCase() === studentEmailLower
                    );
                    const matchingByEmail = videoQuestionAnswersResult.data.filter(a =>
                        a.email && a.email.toLowerCase() === studentEmailLower
                    );
                    console.log('ğŸ“§ Matching by userEmail field:', matchingByUserEmail.length);
                    console.log('ğŸ“§ Matching by email field:', matchingByEmail.length);
                }

                console.log('ğŸ“ Filtered answers:', videoQuestionAnswers);

                // Fetch coordinator videos for context
                const coordinatorVideosResult = await DB.load('coordinatorVideos');
                const allCoordinatorVideos = coordinatorVideosResult.success ? coordinatorVideosResult.data : [];

                console.log('ğŸ¬ Total videos loaded:', allCoordinatorVideos.length);
                console.log('ğŸ¬ Sample video IDs:', allCoordinatorVideos.slice(0, 3).map(v => ({ id: v.id, title: v.title })));

                // Create video question answers HTML
                let videoQuestionAnswersHtml = '';
                console.log('ğŸ¯ Creating video answers HTML, count:', videoQuestionAnswers.length);
                if (videoQuestionAnswers.length > 0) {
                    videoQuestionAnswersHtml = `
                        <div class="mt-6 bg-white p-6 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-question-circle text-primary mr-2"></i>
                                Video Soru CevaplarÄ±
                                <span class="ml-2 text-sm bg-primary text-white px-2 py-1 rounded-full">${videoQuestionAnswers.length}</span>
                            </h3>
                            <div class="space-y-3">
                            ${videoQuestionAnswers.map((answer, index) => {
                                console.log(`ğŸ” Answer ${index}:`, {
                                    videoId: answer.videoId,
                                    videoIdType: typeof answer.videoId,
                                    allFields: Object.keys(answer)
                                });

                                // Try multiple matching strategies
                                let video = allCoordinatorVideos.find(v => v.id === answer.videoId);
                                if (!video) {
                                    // Try with string conversion
                                    video = allCoordinatorVideos.find(v => String(v.id) === String(answer.videoId));
                                }
                                if (!video && answer.video_id) {
                                    // Try alternative field name
                                    video = allCoordinatorVideos.find(v => v.id === answer.video_id);
                                }

                                console.log(`ğŸ” Found video for answer ${index}:`, video ? video.title : 'NOT FOUND');
                                const videoTitle = video ? (video.title || video.name || 'Ä°simsiz Video') : `Video BulunamadÄ± (ID: ${answer.videoId || answer.video_id || 'N/A'})`;
                                const questionType = answer.questionType || 'multiple-choice';
                                const isCorrect = answer.isCorrect;
                                const statusClass = isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                                const statusIcon = isCorrect ? 'fas fa-check-circle' : 'fas fa-times-circle';
                                
                                // Soru tipi badge
                                const typeBadgeClass = questionType === 'open-ended' ? 'bg-green-100 text-green-800' :
                                                      questionType === 'fill-blank' ? 'bg-orange-100 text-orange-800' :
                                                      'bg-blue-100 text-blue-800';
                                const typeBadgeText = questionType === 'open-ended' ? 'AÃ§Ä±k UÃ§lu' :
                                                     questionType === 'fill-blank' ? 'BoÅŸluk Doldurma' :
                                                     'Ã‡oktan SeÃ§meli';
                                
                                // AÃ§Ä±k uÃ§lu sorular iÃ§in Ã¶zel gÃ¶rÃ¼nÃ¼m
                                const answerDisplay = questionType === 'open-ended' ? 
                                    `<div class="mt-2">
                                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                            <div class="flex items-center mb-2">
                                                <i class="fas fa-comment-alt text-blue-600 mr-2"></i>
                                                <span class="text-sm font-semibold text-blue-800">Ã–ÄŸrenci CevabÄ±:</span>
                                            </div>
                                            <textarea readonly class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white text-sm text-gray-900 resize-none" rows="6">${answer.studentAnswer || 'Cevap verilmemiÅŸ'}</textarea>
                                            ${answer.answeredAt ? `
                                                <p class="text-xs text-gray-500 mt-2">
                                                    <i class="fas fa-clock mr-1"></i>CevaplandÄ±: ${new Date(answer.answeredAt).toLocaleString('tr-TR')}
                                                </p>
                                            ` : ''}
                                        </div>
                                    </div>` :
                                    questionType === 'fill-blank' ?
                                    `<div class="mt-2">
                                        <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4">
                                            <div class="flex items-center mb-2">
                                                <i class="fas fa-edit text-orange-600 mr-2"></i>
                                                <span class="text-sm font-semibold text-orange-800">Ã–ÄŸrenci CevaplarÄ±:</span>
                                            </div>
                                            <div class="bg-white p-3 rounded-lg border border-gray-300 mb-2">
                                                <p class="text-sm text-gray-900 font-medium">${answer.studentAnswer || 'Cevap verilmemiÅŸ'}</p>
                                            </div>
                                            ${answer.correctAnswer ? `
                                                <div class="bg-green-50 p-3 rounded-lg border border-green-300">
                                                    <p class="text-sm text-green-800">
                                                        <i class="fas fa-check-circle mr-1"></i>
                                                        <strong>DoÄŸru Cevap:</strong> ${answer.correctAnswer}
                                                    </p>
                                                </div>
                                            ` : ''}
                                            ${answer.answeredAt ? `
                                                <p class="text-xs text-gray-500 mt-2">
                                                    <i class="fas fa-clock mr-1"></i>CevaplandÄ±: ${new Date(answer.answeredAt).toLocaleString('tr-TR')}
                                                </p>
                                            ` : ''}
                                        </div>
                                    </div>` :
                                    `<div class="bg-gray-50 p-3 rounded-lg border border-gray-300">
                                        <span class="text-sm text-gray-900">${answer.studentAnswer || 'Cevap verilmemiÅŸ'}</span>
                                    </div>`;
                                
                                return `
                                    <div class="bg-gray-50 p-4 rounded-lg border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'}">
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <i class="fas fa-video text-primary"></i>
                                                    <h4 class="font-semibold text-gray-900">${videoTitle}</h4>
                                                    <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                                        <i class="${statusIcon} mr-1"></i>${isCorrect ? 'DoÄŸru' : 'YanlÄ±ÅŸ'}
                                                    </span>
                                                    <span class="px-2 py-1 text-xs rounded-full ${typeBadgeClass}">
                                                        ${typeBadgeText}
                                                    </span>
                                                </div>
                                                <p class="text-sm text-gray-700 mb-2"><strong>Soru:</strong> ${answer.questionText}</p>
                                                <p class="text-sm text-gray-700"><strong>Ã–ÄŸrenci CevabÄ±:</strong> <span class="text-blue-600">${answer.studentAnswer || 'Cevap verilmemiÅŸ'}</span></p>
                                                ${!isCorrect && answer.correctAnswer ? `
                                                    <p class="text-sm text-gray-700 mt-1"><strong>DoÄŸru Cevap:</strong> <span class="text-green-600">${answer.correctAnswer}</span></p>
                                                ` : ''}
                                                ${answer.answeredAt ? `
                                                    <p class="text-xs text-gray-500 mt-2">
                                                        <i class="fas fa-clock mr-1"></i>${new Date(answer.answeredAt).toLocaleString('tr-TR')}
                                                    </p>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    `;
                } else {
                    videoQuestionAnswersHtml = `
                        <div class="mt-6 bg-gray-50 p-6 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-semibold mb-3 flex items-center">
                                <i class="fas fa-question-circle text-gray-400 mr-2"></i>
                                Video Soru CevaplarÄ±
                            </h3>
                            <p class="text-gray-500 text-sm">HenÃ¼z video sorularÄ±na cevap verilmemiÅŸ.</p>
                        </div>
                    `;
                }

                console.log('âœ… Video answers HTML created, length:', videoQuestionAnswersHtml.length);
            
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">KiÅŸisel Bilgiler</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Ad Soyad</label>
                                <p class="mt-1 text-sm text-gray-900">${student.name}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">E-posta</label>
                                <p class="mt-1 text-sm text-gray-900">${student.email}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">KatÄ±lÄ±m Tarihi</label>
                                <p class="mt-1 text-sm text-gray-900">${formatDate(student.joinDate)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">EÄŸitim Ä°statistikleri</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Genel Ä°lerleme</label>
                                <div class="mt-1 flex items-center">
                                    <div class="w-full bg-gray-200 rounded-full h-2 mr-3">
                                        <div class="bg-gradient-to-r from-primary to-accent h-2 rounded-full" style="width: ${student.totalProgress}%"></div>
                                    </div>
                                    <span class="text-sm font-medium">${student.totalProgress}%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tamamlanan ModÃ¼ller</label>
                                <p class="mt-1 text-sm text-gray-900">${student.completedModules}/${student.totalModules} modÃ¼l</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Not SayÄ±sÄ±</label>
                                <p class="mt-1 text-sm text-gray-900">${student.notes} not</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Son Aktivite</label>
                                <p class="mt-1 text-sm text-gray-900">${formatRelativeTime(student.lastActivity)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Durum</label>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                    student.isActive 
                                        ? 'bg-green-100 text-green-800' 
                                        : 'bg-gray-100 text-gray-800'
                                }">
                                    ${student.isActive ? 'Aktif' : 'Pasif'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-4">ModÃ¼l BazlÄ± Ä°lerleme</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${Object.entries(student.moduleProgress).map(([moduleId, progress]) => {
                            const moduleName = moduleMap[moduleId] || 'ModÃ¼l ' + moduleId;
                            return `
                            <div class="border rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-medium">${moduleName}</h4>
                                    <span class="text-sm font-medium">${progress}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-primary to-accent h-2 rounded-full" style="width: ${progress}%"></div>
                                </div>
                                <div class="mt-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                        progress >= 100
                                            ? 'bg-green-100 text-green-800'
                                            : progress >= 50
                                                ? 'bg-yellow-100 text-yellow-800'
                                                : 'bg-red-100 text-red-800'
                                    }">
                                        ${progress >= 100 ? 'TamamlandÄ±' : progress >= 50 ? 'Devam Ediyor' : 'BaÅŸlanmadÄ±'}
                                    </span>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-4">Ek Bilgiler</h3>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-700">
                            <strong>E-posta:</strong> ${student.email}
                        </p>
                        <p class="text-sm text-gray-700 mt-2">
                            <strong>Son Aktivite:</strong> ${formatRelativeTime(student.lastActivity)}
                        </p>
                        <p class="text-sm text-gray-700 mt-2">
                            <strong>Durum:</strong> 
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                student.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                            }">
                                ${student.isActive ? 'Aktif' : 'Pasif'}
                            </span>
                        </p>
                        <p class="text-sm text-gray-700 mt-2">
                            <strong>Toplam Ä°lerleme:</strong> ${student.totalProgress}%
                        </p>
                    </div>
                </div>
                ${videoQuestionAnswersHtml}
            `;
            
            modal.classList.remove('hidden');
            console.log('Modal aÃ§Ä±ldÄ±!');
            
            } catch (error) {
                console.error('âŒ Ã–ÄŸrenci detaylarÄ± yÃ¼klenirken hata oluÅŸtu:', error);
                content.innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
                        <p class="text-lg">Detaylar yÃ¼klenirken bir hata oluÅŸtu.</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        // Close student modal
        function closeStudentModal() {
            document.getElementById('student-modal').classList.add('hidden');
        }

        // Open add student modal
        function openAddStudentModal() {
            document.getElementById('add-student-modal').classList.remove('hidden');
            document.getElementById('add-student-form').reset();
        }

        // Close add student modal
        function closeAddStudentModal() {
            document.getElementById('add-student-modal').classList.add('hidden');
            document.getElementById('add-student-form').reset();
        }

        // Handle add student form submission
        async function handleAddStudent(e) {
            e.preventDefault();

            const firstName = document.getElementById('student-firstname').value.trim();
            const lastName = document.getElementById('student-lastname').value.trim();
            const email = document.getElementById('student-email').value.trim();
            const password = document.getElementById('student-password').value;
            const studentId = document.getElementById('student-id').value.trim();

            try {
                console.log('ğŸ‘¤ Yeni Ã¶ÄŸrenci ekleniyor...', email);

                // Create user in Firebase Auth
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                console.log('âœ… Firebase Auth kullanÄ±cÄ± oluÅŸturuldu');

                // Create user profile in Firestore
                const userProfile = {
                    id: `user_${email}_${Date.now()}`,
                    userEmail: email,
                    firstName: firstName,
                    lastName: lastName,
                    studentId: studentId || '',
                    role: 'student',
                    password: password,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    joinDate: new Date().toISOString(),
                    isActive: true
                };

                await window.DB.save('userProfiles', userProfile);
                console.log('âœ… KullanÄ±cÄ± profili oluÅŸturuldu');

                showSuccess(`${firstName} ${lastName} baÅŸarÄ±yla eklendi!`);
                closeAddStudentModal();

                // Reload students
                await loadStudents();

            } catch (error) {
                console.error('âŒ Ã–ÄŸrenci ekleme hatasÄ±:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showError('Bu e-posta adresi zaten kullanÄ±mda.');
                } else if (error.code === 'auth/invalid-email') {
                    showError('GeÃ§ersiz e-posta adresi.');
                } else if (error.code === 'auth/weak-password') {
                    showError('Åifre en az 6 karakter olmalÄ±dÄ±r.');
                } else {
                    showError('Ã–ÄŸrenci eklenirken hata oluÅŸtu: ' + error.message);
                }
            }
        }

        // Show error message
        function showError(message) {
            console.error('âŒ Hata:', message);
            
            // Create error toast
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-3"></i>
                    <div class="flex-1">
                        <p class="font-medium">Hata OluÅŸtu</p>
                        <p class="text-sm opacity-90">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Mark open-ended answer as correct
        async function markOpenEndedAsCorrect(answerId, userEmail, questionIndex) {
            try {
                if (!confirm('Bu aÃ§Ä±k uÃ§lu cevabÄ± doÄŸru olarak iÅŸaretlemek istediÄŸinizden emin misiniz?')) {
                    return;
                }

                // Load all video question answers
                const answersResult = await window.DB.load('videoQuestionAnswers');
                if (!answersResult.success) {
                    alert('Cevap bulunamadÄ±!');
                    return;
                }

                // Find the answer
                const allAnswers = Array.isArray(answersResult.data) 
                    ? answersResult.data 
                    : Object.values(answersResult.data || {});
                
                const answer = allAnswers.find(a => 
                    a.userEmail === userEmail && 
                    a.questionIndex === questionIndex &&
                    (answerId ? a.id === answerId : true)
                );

                if (!answer) {
                    alert('Cevap bulunamadÄ±!');
                    return;
                }

                // Update answer
                answer.isCorrect = true;
                answer.evaluatedAt = new Date().toISOString();
                answer.evaluatedBy = localStorage.getItem('userEmail');

                // Save updated answer
                const saveResult = await window.DB.save('videoQuestionAnswers', answer, answer.id || answerId);
                
                if (saveResult && saveResult.success) {
                    showNotification('âœ… Cevap doÄŸru olarak iÅŸaretlendi!', 'success');
                    
                    // Reload student details to show updated status
                    const currentStudentId = document.querySelector('[data-student-id]')?.dataset.studentId;
                    if (currentStudentId) {
                        await viewStudentDetail(currentStudentId);
                    }
                } else {
                    throw new Error('Cevap gÃ¼ncellenemedi');
                }
            } catch (error) {
                console.error('âŒ Cevap iÅŸaretleme hatasÄ±:', error);
                alert('Hata: ' + error.message);
            }
        }

        // Logout function
        function logout() {
            if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('loginTime');
                localStorage.removeItem('userRole');
                
                console.log('ğŸšª KoordinatÃ¶r Ã§Ä±kÄ±ÅŸÄ± yapÄ±ldÄ±');
                window.location.href = 'index.html';
            }
        }
        
        // ULTRA STRONG SIDEBAR VISIBILITY SYSTEM
        function ensureSidebarVisibility() {
            const sidebar = document.querySelector('aside');
            if (sidebar) {
                // Force sidebar to stay visible with ULTRA STRONG rules
                sidebar.style.position = 'fixed';
                sidebar.style.zIndex = '999999';
                sidebar.style.left = '0';
                sidebar.style.top = '0';
                sidebar.style.height = '100vh';
                sidebar.style.overflowY = 'auto';
                sidebar.style.transform = 'none';
                sidebar.style.willChange = 'auto';
                sidebar.style.pointerEvents = 'auto';
                sidebar.style.display = 'block';
                sidebar.style.visibility = 'visible';
                sidebar.style.opacity = '1';
                
                // Add CSS class for additional safety
                sidebar.classList.add('sidebar-container');
                
                console.log('ğŸ”’ Sidebar gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ korunuyor - Z-Index:', sidebar.style.zIndex);
            }
        }
        
        // Start continuous sidebar visibility check
        function startSidebarVisibilityCheck() {
            // Check every 50ms (ultra frequent)
            setInterval(ensureSidebarVisibility, 50);
            
            // Check on all possible events
            const events = ['scroll', 'resize', 'load', 'visibilitychange', 'focus', 'blur', 'click', 'mousemove', 'keydown'];
            events.forEach(event => {
                window.addEventListener(event, ensureSidebarVisibility);
                document.addEventListener(event, ensureSidebarVisibility);
            });
            
            // Additional safety: check on DOM changes
            const observer = new MutationObserver(ensureSidebarVisibility);
            observer.observe(document.body, { 
                childList: true, 
                subtree: true, 
                attributes: true,
                attributeFilter: ['style', 'class']
            });
            
            console.log('ğŸš€ Ultra gÃ¼Ã§lÃ¼ sidebar gÃ¶rÃ¼nÃ¼rlÃ¼k sistemi baÅŸlatÄ±ldÄ±!');
        }
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', ensureSidebarVisibility);
        window.addEventListener('load', ensureSidebarVisibility);
    </script>
</body>
</html> 