<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Force Clean - Video Temizleme</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-bold mb-8">ğŸ”¥ Force Clean - Silinen VideolarÄ± Temizle</h1>

        <div class="bg-red-900/50 border border-red-500 p-4 rounded-lg mb-6">
            <p class="text-red-300 font-bold">
                âš ï¸ DÄ°KKAT: Bu araÃ§ Firestore'a DOÄRUDAN baÄŸlanÄ±r ve silinen videolarÄ± kalÄ±cÄ± olarak siler!
            </p>
        </div>

        <!-- Status -->
        <div id="status" class="mb-6 p-4 rounded-lg bg-gray-800">
            <p>Bekleniyor...</p>
        </div>

        <!-- Actions -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button onclick="checkFirebaseConnection()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold">
                1. Firebase BaÄŸlantÄ±sÄ±nÄ± Kontrol Et
            </button>
            <button onclick="listAllVideos()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-semibold">
                2. TÃ¼m VideolarÄ± Listele
            </button>
            <button onclick="forceCleanDeleted()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold">
                3. FORCE DELETE (Silinen VideolarÄ± Sil)
            </button>
            <button onclick="clearCacheAndReload()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold">
                4. Cache Temizle ve Yenile
            </button>
        </div>

        <!-- Results -->
        <div class="bg-gray-800 p-6 rounded-lg overflow-auto" style="max-height: 600px;">
            <h3 class="text-xl font-bold mb-4 sticky top-0 bg-gray-800">ğŸ“Š SonuÃ§lar:</h3>
            <pre id="results" class="text-sm whitespace-pre-wrap"></pre>
        </div>
    </div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-production.js"></script>

    <script>
        function log(message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
            results.scrollTop = results.scrollHeight;
        }

        function clearLog() {
            document.getElementById('results').textContent = '';
        }

        function updateStatus(message, color = 'bg-gray-800') {
            const status = document.getElementById('status');
            status.className = `mb-6 p-4 rounded-lg ${color}`;
            status.innerHTML = `<p class="font-bold">${message}</p>`;
        }

        async function checkFirebaseConnection() {
            clearLog();
            updateStatus('Firebase baÄŸlantÄ±sÄ± kontrol ediliyor...', 'bg-blue-900');

            try {
                log('ğŸ” Firebase durumu kontrol ediliyor...');

                // Check if Firebase is loaded
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK yÃ¼klenmedi!');
                }
                log('âœ… Firebase SDK yÃ¼klendi');

                // Check if app is initialized
                if (!firebase.apps || firebase.apps.length === 0) {
                    throw new Error('Firebase app baÅŸlatÄ±lmadÄ±!');
                }
                log('âœ… Firebase app baÅŸlatÄ±ldÄ±');

                // Check Firestore
                const db = firebase.firestore();
                if (!db) {
                    throw new Error('Firestore eriÅŸilemiyor!');
                }
                log('âœ… Firestore eriÅŸilebilir');

                // Try to read collection
                log('\nğŸ“š coordinatorVideos koleksiyonu okunuyor...');
                const snapshot = await db.collection('coordinator_videos').get();
                log(`âœ… Koleksiyon okundu: ${snapshot.size} dokÃ¼man bulundu`);

                updateStatus(`âœ… Firebase Ã‡ALIÅIYOR! ${snapshot.size} video bulundu.`, 'bg-green-900');

                return true;

            } catch (error) {
                log(`\nâŒ HATA: ${error.message}`);
                updateStatus('âŒ Firebase baÄŸlantÄ± hatasÄ±!', 'bg-red-900');
                return false;
            }
        }

        async function listAllVideos() {
            clearLog();
            updateStatus('Videolar listeleniyor...', 'bg-blue-900');

            try {
                log('ğŸ“š TÃ¼m videolar yÃ¼kleniyor...\n');

                const db = firebase.firestore();
                const snapshot = await db.collection('coordinator_videos').get();

                log(`ğŸ“Š TOPLAM: ${snapshot.size} video\n`);

                const deletedVideos = [];
                const activeVideos = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const videoInfo = {
                        id: doc.id,
                        title: data.title || 'Ä°simsiz',
                        status: data.status || 'active'
                    };

                    if (data.status === 'deleted') {
                        deletedVideos.push(videoInfo);
                    } else {
                        activeVideos.push(videoInfo);
                    }
                });

                log(`âœ… Aktif: ${activeVideos.length}`);
                log(`ğŸ—‘ï¸  SilinmiÅŸ: ${deletedVideos.length}\n`);

                if (deletedVideos.length > 0) {
                    log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    log('SÄ°LÄ°NMÄ°Å VÄ°DEOLAR:');
                    log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
                    deletedVideos.forEach((v, i) => {
                        log(`${i + 1}. ${v.title}`);
                        log(`   ID: ${v.id}\n`);
                    });
                }

                if (activeVideos.length > 0) {
                    log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    log('AKTÄ°F VÄ°DEOLAR:');
                    log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
                    activeVideos.forEach((v, i) => {
                        log(`${i + 1}. ${v.title}`);
                        log(`   ID: ${v.id}\n`);
                    });
                }

                updateStatus(`ğŸ“Š ${activeVideos.length} aktif, ${deletedVideos.length} silinmiÅŸ video`, 'bg-purple-900');

            } catch (error) {
                log(`\nâŒ HATA: ${error.message}`);
                updateStatus('âŒ Liste alÄ±namadÄ±!', 'bg-red-900');
            }
        }

        async function forceCleanDeleted() {
            if (!confirm('âš ï¸ SÄ°LÄ°NMÄ°Å VÄ°DEOLARI KALICI OLARAK SÄ°LMEK Ä°STEDÄ°ÄÄ°NÄ°ZE EMÄ°N MÄ°SÄ°NÄ°Z?\n\nBu iÅŸlem geri alÄ±namaz!')) {
                return;
            }

            clearLog();
            updateStatus('FORCE DELETE baÅŸlatÄ±lÄ±yor...', 'bg-red-900');

            try {
                log('ğŸ”¥ FORCE DELETE BAÅLATILDI\n');

                const db = firebase.firestore();
                const snapshot = await db.collection('coordinator_videos').get();

                log(`ğŸ“š ${snapshot.size} video taranÄ±yor...\n`);

                const deletedVideos = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'deleted') {
                        deletedVideos.push({
                            id: doc.id,
                            title: data.title || 'Ä°simsiz'
                        });
                    }
                });

                if (deletedVideos.length === 0) {
                    log('âœ… Silinecek video yok!');
                    updateStatus('âœ… VeritabanÄ± temiz!', 'bg-green-900');
                    return;
                }

                log(`ğŸ—‘ï¸  ${deletedVideos.length} SÄ°LÄ°NMÄ°Å VÄ°DEO BULUNDU\n`);
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

                let successCount = 0;
                let errorCount = 0;

                for (const video of deletedVideos) {
                    try {
                        log(`Siliniyor: ${video.title}...`);

                        // DOÄRUDAN Firestore'dan sil
                        await db.collection('coordinator_videos').doc(video.id).delete();

                        log(`âœ… SÄ°LÄ°NDÄ°: ${video.title}\n`);
                        successCount++;

                        // Rate limiting iÃ§in kÃ¼Ã§Ã¼k gecikme
                        await new Promise(r => setTimeout(r, 200));

                    } catch (error) {
                        log(`âŒ HATA: ${video.title} - ${error.message}\n`);
                        errorCount++;
                    }
                }

                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
                log(`âœ… BaÅŸarÄ±lÄ±: ${successCount}`);
                log(`âŒ BaÅŸarÄ±sÄ±z: ${errorCount}\n`);

                updateStatus(`âœ… Temizlendi! ${successCount} video silindi.`, 'bg-green-900');

                // Clear all caches
                if (window.DB && window.DB.clearCache) {
                    window.DB.clearCache();
                    log('ğŸ§¹ Cache temizlendi');
                }

                log('\nğŸ‰ Ä°ÅLEM TAMAMLANDI!');
                log('KoordinatÃ¶r panelini yenileyin.');

            } catch (error) {
                log(`\nâŒ BÃœYÃœK HATA: ${error.message}`);
                updateStatus('âŒ Ä°ÅŸlem baÅŸarÄ±sÄ±z!', 'bg-red-900');
            }
        }

        async function clearCacheAndReload() {
            clearLog();
            log('ğŸ§¹ Cache temizleniyor...\n');

            // Clear DB cache
            if (window.DB && window.DB.clearCache) {
                window.DB.clearCache();
                log('âœ… DB cache temizlendi');
            }

            // Clear browser cache
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                for (const name of cacheNames) {
                    await caches.delete(name);
                }
                log('âœ… Browser cache temizlendi');
            }

            log('\nğŸ”„ Sayfa 2 saniye sonra yenilenecek...');

            updateStatus('Cache temizlendi! Sayfa yenileniyor...', 'bg-green-900');

            setTimeout(() => {
                location.reload(true);
            }, 2000);
        }

        // Auto-start
        window.addEventListener('DOMContentLoaded', function() {
            updateStatus('HazÄ±r! Ä°lk Ã¶nce "Firebase BaÄŸlantÄ±sÄ±nÄ± Kontrol Et" butonuna tÄ±klayÄ±n.', 'bg-blue-900');
        });
    </script>
</body>
</html>
